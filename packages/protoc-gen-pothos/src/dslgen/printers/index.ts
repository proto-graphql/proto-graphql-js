import type { GeneratedFile, createRegistry } from "@bufbuild/protobuf";
import {
  EnumType,
  InputObjectType,
  ObjectType,
  OneofUnionType,
  SquashedOneofUnionType,
} from "@proto-graphql/codegen-core";
import type { Code } from "ts-poet";

import { createEnumTypeCode, printEnumType } from "./enumType.js";
import { createInputObjectTypeCode, printInputObjectType } from "./inputObjectType.js";
import { createObjectTypeCode, printObjectType } from "./objectType.js";
import { createOneofUnionTypeCode, printOneofUnionType } from "./oneofUnionType.js";
import type { PothosPrinterOptions } from "./util.js";

export function createTypeDslCodes(
  types: (
    | ObjectType
    | InputObjectType
    | EnumType
    | OneofUnionType
    | SquashedOneofUnionType
  )[],
  registry: ReturnType<typeof createRegistry>,
  opts: PothosPrinterOptions,
): Code[] {
  return types.flatMap((type) => {
    if (type instanceof ObjectType) {
      return createObjectTypeCode(type, registry, opts);
    }
    if (type instanceof InputObjectType) {
      return createInputObjectTypeCode(type, registry, opts);
    }
    if (type instanceof EnumType) {
      return [createEnumTypeCode(type, registry, opts)];
    }
    if (
      type instanceof OneofUnionType ||
      type instanceof SquashedOneofUnionType
    ) {
      return [createOneofUnionTypeCode(type, registry, opts)];
    }

    const _exhaustiveCheck: never = type;
    throw "unreachable";
  });
}

export function printTypeDsl(
  f: GeneratedFile,
  types: (
    | ObjectType
    | InputObjectType
    | EnumType
    | OneofUnionType
    | SquashedOneofUnionType
  )[],
  registry: ReturnType<typeof createRegistry>,
  opts: PothosPrinterOptions,
): void {
  // Generate header comment
  f.print("// Code generated by protoc-gen-pothos. DO NOT EDIT.");
  f.print("");
  f.print("/* eslint-disable */");
  f.print("");
  
  // Print each type
  types.forEach((type, index) => {
    if (index > 0) {
      f.print("");
    }
    
    if (type instanceof ObjectType) {
      printObjectType(f, type, registry, opts);
    } else if (type instanceof InputObjectType) {
      printInputObjectType(f, type, registry, opts);
    } else if (type instanceof EnumType) {
      printEnumType(f, type, registry, opts);
    } else if (
      type instanceof OneofUnionType ||
      type instanceof SquashedOneofUnionType
    ) {
      printOneofUnionType(f, type, registry, opts);
    } else {
      const _exhaustiveCheck: never = type;
      throw "unreachable";
    }
  });
}
