import type { DescFile } from "@bufbuild/protobuf";
import { type Code, code } from "ts-poet";

/**
 * ts-poet's imp() cannot correctly parse symbol names containing '$'.
 * We work around this by using a placeholder during parsing,
 * and replacing it back in the final output.
 */
const DOLLAR_PLACEHOLDER = "__PROTO_GRAPHQL_DOLLAR__";

function unescapeDollarInOutput(output: string): string {
  return output.replace(new RegExp(DOLLAR_PLACEHOLDER, "g"), "$");
}

export function printCodes(
  codes: Code[],
  programName: string,
  file: DescFile,
): string {
  const rawOutput = (
    codes.length === 0 ? code`export {};` : code`${codes}`
  ).toString({
    prefix: `
      // Code generated by ${programName}. DO NOT EDIT.
      // source: ${file.name}.proto

      /* eslint-disable */
    `,
    dprintOptions: {
      lineWidth: 80,
      indentWidth: 2,
      useTabs: false,
      semiColons: "always",
      quoteStyle: "alwaysDouble",
      quoteProps: "asNeeded",
      newLineKind: "lf",
      useBraces: "whenNotSingleLine",
      bracePosition: "sameLineUnlessHanging",
      singleBodyPosition: "maintain",
      nextControlFlowPosition: "sameLine",
      trailingCommas: "onlyMultiLine",
      operatorPosition: "nextLine",
      preferHanging: false,
      "arrowFunction.useParentheses": "force",
    },
  });

  // Restore $ signs that were escaped for ts-poet compatibility
  return unescapeDollarInOutput(rawOutput);
}
