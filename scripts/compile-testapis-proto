#!/usr/bin/env bash

set -eu
set -o pipefail

cd $(dirname $0)/..

PROTO_ROOT=./devPackages/testapis-proto/proto
OUT_ROOT=./tests/testapis

clean() {
  rm -rf $OUT_ROOT/ts-proto/{src,lib}
  rm -rf $OUT_ROOT/ts-proto-with-forcelong-long/{src,lib}
  rm -rf $OUT_ROOT/ts-proto-with-forcelong-number/{src,lib}
  rm -rf $OUT_ROOT/protobuf-es/{src,lib}
  rm -rf $OUT_ROOT/protobuf-es-v2/{src,lib}
}

init() {
  mkdir -p $OUT_ROOT/ts-proto/{src,lib}
  mkdir -p $OUT_ROOT/ts-proto-with-forcelong-long/{src,lib}
  mkdir -p $OUT_ROOT/ts-proto-with-forcelong-number/{src,lib}
  mkdir -p $OUT_ROOT/protobuf-es/{src,lib}
  mkdir -p $OUT_ROOT/protobuf-es-v2/{src,lib}
}

execProtoc() {
  PATH=$PATH:$(pnpm bin -w) pnpm buf generate --template buf.gen.e2e.yaml
}

_main() {
  clean
  init
  execProtoc
}

_main
